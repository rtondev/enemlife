{% extends "dashboard_base.html" %}

{% block title %}Relatórios - ENEMLIFE{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h2 class="text-2xl font-bold text-gray-900">Relatórios</h2>
        <p class="text-gray-600">Acompanhe seu progresso e desempenho</p>
    </div>
</div>

<!-- Stats Overview -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl p-6 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Conteúdos</p>
                <p class="text-2xl font-bold text-gray-900" id="conteudos-studied">0</p>
            </div>
            <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i data-lucide="book" class="w-6 h-6 text-emerald-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl p-6 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Simulados</p>
                <p class="text-2xl font-bold text-gray-900" id="simulados-completed">0</p>
            </div>
            <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i data-lucide="clipboard-check" class="w-6 h-6 text-emerald-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl p-6 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Flashcards</p>
                <p class="text-2xl font-bold text-gray-900" id="flashcards-count">0</p>
            </div>
            <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i data-lucide="zap" class="w-6 h-6 text-emerald-600"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-xl p-6 border border-gray-200">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-600 mb-1">Questões</p>
                <p class="text-2xl font-bold text-gray-900" id="questoes-count">0</p>
            </div>
            <div class="w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                <i data-lucide="help-circle" class="w-6 h-6 text-emerald-600"></i>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="bg-white rounded-xl p-6 border border-gray-200 mb-8">
    <h3 class="text-lg font-semibold text-gray-900 mb-6">Atividade Recente</h3>
    <div id="recent-activity" class="space-y-3">
        <div class="text-center py-12 text-gray-500">
            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
            <p>Carregando atividades...</p>
        </div>
    </div>
</div>

<!-- Study Goals -->
<div class="bg-white rounded-xl p-6 border border-gray-200">
    <h3 class="text-lg font-semibold text-gray-900 mb-6">Metas de Estudo</h3>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="book-open" class="w-8 h-8 text-emerald-600"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-1">Conteúdos por Semana</h4>
            <p class="text-2xl font-bold text-emerald-600" id="weekly-content-goal">5</p>
            <p class="text-sm text-gray-500">conteúdos estudados</p>
        </div>
        
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="clipboard-check" class="w-8 h-8 text-emerald-600"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-1">Simulados por Mês</h4>
            <p class="text-2xl font-bold text-emerald-600" id="monthly-simulado-goal">2</p>
            <p class="text-sm text-gray-500">simulados realizados</p>
        </div>
        
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="target" class="w-8 h-8 text-emerald-600"></i>
            </div>
            <h4 class="font-semibold text-gray-900 mb-1">Meta de Acerto</h4>
            <p class="text-2xl font-bold text-emerald-600" id="accuracy-goal">80%</p>
            <p class="text-sm text-gray-500">taxa de acerto</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    async function loadReportsData() {
        const token = localStorage.getItem('token');
        
        try {
            const statsResponse = await fetch('/api/estatisticas', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                
                document.getElementById('conteudos-studied').textContent = stats.usuario.conteudos || 0;
                document.getElementById('simulados-completed').textContent = stats.usuario.simulados || 0;
                document.getElementById('flashcards-count').textContent = stats.usuario.flashcards || 0;
                document.getElementById('questoes-count').textContent = stats.usuario.questoes || 0;
            }
            
            loadRecentActivity();
            
        } catch (error) {
            console.error('Erro ao carregar estatísticas:', error);
        }
    }
    
    async function loadRecentActivity() {
        const token = localStorage.getItem('token');
        
        try {
            const contentsResponse = await fetch('/api/conteudos', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (contentsResponse.ok) {
                const contents = await contentsResponse.json();
                const recentContents = contents.slice(0, 3);
                
                const simuladosResponse = await fetch('/api/simulados', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                let recentSimulados = [];
                if (simuladosResponse.ok) {
                    const simulados = await simuladosResponse.json();
                    recentSimulados = simulados.slice(0, 2);
                }
                
                const activities = [
                    ...recentContents.map(content => ({
                        type: 'content',
                        title: `Novo conteúdo: ${content.nome}`,
                        time: content.created_at,
                        icon: 'book',
                        color: 'emerald'
                    })),
                    ...recentSimulados.map(simulado => ({
                        type: 'simulado',
                        title: `Simulado criado: ${simulado.nome}`,
                        time: simulado.created_at,
                        icon: 'clipboard-check',
                        color: 'emerald'
                    }))
                ].sort((a, b) => new Date(b.time) - new Date(a.time));
                
                renderRecentActivity(activities);
            }
            
        } catch (error) {
            console.error('Erro ao carregar atividades:', error);
        }
    }
    
    function renderRecentActivity(activities) {
        const container = document.getElementById('recent-activity');
        
        if (activities.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="activity" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <p>Nenhuma atividade recente</p>
                </div>
            `;
            lucide.createIcons();
            return;
        }
        
        container.innerHTML = activities.map(activity => `
            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-emerald-400 transition-colors">
                <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i data-lucide="${activity.icon}" class="w-5 h-5 text-emerald-600"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">${activity.title}</p>
                    <p class="text-xs text-gray-500">${new Date(activity.time).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                </div>
            </div>
        `).join('');
        
        lucide.createIcons();
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        loadReportsData();
    });
</script>
{% endblock %}
