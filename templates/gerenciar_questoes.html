{% extends "dashboard_base.html" %}

{% block title %}Gerenciar Questões - ENEMLIFE{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex items-center justify-between mb-8">
    <div>
        <h2 class="text-2xl font-bold text-gray-900" id="page-title">Gerenciar Questões</h2>
        <p class="text-gray-600" id="simulado-name">Carregando...</p>
    </div>
    <a href="{{ url_for('simulados_page') }}" class="btn-secondary">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Voltar
    </a>
</div>

    <!-- Content -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Available Questions -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Questões Disponíveis</h2>
            <div id="available-questions" class="space-y-3 max-h-[600px] overflow-y-auto">
                <div class="text-center py-12 text-gray-500">
                    <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                    <p>Carregando questões...</p>
                </div>
            </div>
        </div>
        
        <!-- Simulado Questions -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Questões do Simulado</h2>
            <div id="simulado-questions" class="space-y-3 max-h-[600px] overflow-y-auto">
                <div class="text-center py-12 text-gray-500">
                    <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                    <p>Carregando questões...</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    const simuladoId = {{ simulado_id }};
    let allQuestoes = [];
    let currentSimuladoQuestoes = [];
    let currentSimulado = null;
    
    async function loadData() {
        const token = localStorage.getItem('token');
        
        try {
            // Carregar questões do usuário
            const questoesResponse = await fetch('/api/questoes', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (questoesResponse.ok) {
                allQuestoes = await questoesResponse.json();
            }
            
            // Carregar informações do simulado e suas questões
            const simuladoResponse = await fetch(`/api/simulados/questoes/${simuladoId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (simuladoResponse.ok) {
                const data = await simuladoResponse.json();
                currentSimulado = data;
                currentSimuladoQuestoes = data.questoes || [];
                
                document.getElementById('page-title').textContent = `Gerenciar Questões - ${currentSimulado.nome}`;
                document.getElementById('simulado-name').textContent = currentSimulado.descricao || 'Sem descrição';
            }
            
            renderQuestions();
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            alert('Erro ao carregar dados');
        }
    }
    
    function renderQuestions() {
        const availableQuestoes = allQuestoes.filter(q => 
            !currentSimuladoQuestoes.some(sq => sq.id === q.id)
        );
        
        // Renderizar questões disponíveis
        if (availableQuestoes.length === 0) {
            document.getElementById('available-questions').innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i data-lucide="help-circle" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                    <p>Nenhuma questão disponível</p>
                </div>
            `;
        } else {
            document.getElementById('available-questions').innerHTML = availableQuestoes.map(questao => `
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 hover:border-emerald-400 transition-colors">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 mb-2">${questao.pergunta.substring(0, 100)}${questao.pergunta.length > 100 ? '...' : ''}</p>
                            <div class="flex items-center gap-2">
                                <span class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded">${questao.tipo}</span>
                                <span class="text-xs text-gray-500">Resposta: ${questao.correta}</span>
                            </div>
                        </div>
                        <button onclick="addQuestionToSimulado(${questao.id})" class="ml-4 p-2 text-emerald-600 hover:bg-emerald-50 rounded-lg transition-colors" title="Adicionar ao simulado">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Renderizar questões do simulado
        if (currentSimuladoQuestoes.length === 0) {
            document.getElementById('simulado-questions').innerHTML = `
                <div class="text-center py-12 text-gray-500">
                    <i data-lucide="clipboard" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                    <p>Nenhuma questão adicionada</p>
                    <p class="text-sm mt-2">Adicione questões da lista ao lado</p>
                </div>
            `;
        } else {
            document.getElementById('simulado-questions').innerHTML = currentSimuladoQuestoes.map((questao, index) => `
                <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-semibold text-emerald-700">Questão ${index + 1}</span>
                                <span class="text-xs px-2 py-1 bg-emerald-200 text-emerald-700 rounded">${questao.tipo || 'N/A'}</span>
                            </div>
                            <p class="text-sm font-medium text-gray-900 mb-2">${questao.pergunta.substring(0, 100)}${questao.pergunta.length > 100 ? '...' : ''}</p>
                            <span class="text-xs text-gray-600">Resposta correta: ${questao.correta}</span>
                        </div>
                        <button onclick="removeQuestionFromSimulado(${questao.id})" class="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Remover do simulado">
                            <i data-lucide="minus" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        lucide.createIcons();
    }
    
    async function addQuestionToSimulado(questaoId) {
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/simulados/${simuladoId}/adicionar-questao`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ questao_id: questaoId })
            });
            
            if (response.ok) {
                await loadData();
            } else {
                const error = await response.json();
                alert('Erro: ' + error.error);
            }
        } catch (error) {
            alert('Erro ao adicionar questão');
        }
    }
    
    async function removeQuestionFromSimulado(questaoId) {
        const token = localStorage.getItem('token');
        
        try {
            const response = await fetch(`/api/simulados/${simuladoId}/remover-questao`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ questao_id: questaoId })
            });
            
            if (response.ok) {
                await loadData();
            } else {
                const error = await response.json();
                alert('Erro: ' + error.error);
            }
        } catch (error) {
            alert('Erro ao remover questão');
        }
    }
    
    // Carregar dados quando a página carregar
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });
</script>
{% endblock %}

