{% extends "dashboard_base.html" %}

{% block title %}Meu Perfil - ENEMLIFE{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Meu Perfil</h2>
            <p class="text-gray-600">Gerencie suas informações pessoais e configurações da conta</p>
        </div>
        <button id="edit-toggle" class="btn-primary self-start sm:self-auto">
            <i data-lucide="edit-3" class="w-4 h-4"></i>
            Editar Perfil
        </button>
    </div>
</div>

<!-- Profile Header Section -->
<div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
    <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-6">
        <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center flex-shrink-0">
            <i data-lucide="user" class="w-10 h-10 text-emerald-600"></i>
        </div>
        <div class="text-center sm:text-left flex-1">
            <h3 id="profile-name" class="text-xl font-semibold text-gray-900 mb-1">Carregando...</h3>
            <p id="profile-email" class="text-gray-600 mb-2">Carregando...</p>
            <span id="profile-role" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                Carregando...
            </span>
        </div>
    </div>
</div>

<!-- Profile Info Section (Read-only) -->
<div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-6">Informações Pessoais</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label class="form-label">Nome Completo</label>
            <div id="display-nome_completo" class="form-input bg-gray-50">-</div>
        </div>
        <div>
            <label class="form-label">Apelido</label>
            <div id="display-apelido" class="form-input bg-gray-50">-</div>
        </div>
        <div>
            <label class="form-label">E-mail</label>
            <div id="display-email" class="form-input bg-gray-50">-</div>
        </div>
        <div>
            <label class="form-label">Telefone</label>
            <div id="display-telefone" class="form-input bg-gray-50">-</div>
        </div>
        <div>
            <label class="form-label">Data de Nascimento</label>
            <div id="display-data_nascimento" class="form-input bg-gray-50">-</div>
        </div>
        <div>
            <label class="form-label">Escolaridade</label>
            <div id="display-escolaridade" class="form-input bg-gray-50">-</div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Editar Perfil</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="profile-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nome Completo -->
                    <div>
                        <label for="edit-nome_completo" class="form-label">Nome Completo</label>
                        <input 
                            type="text" 
                            id="edit-nome_completo" 
                            name="nome_completo"
                            class="form-input"
                            required
                        >
                    </div>

                    <!-- Apelido -->
                    <div>
                        <label for="edit-apelido" class="form-label">Apelido</label>
                        <input 
                            type="text" 
                            id="edit-apelido" 
                            name="apelido"
                            class="form-input"
                            required
                        >
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="edit-email" class="form-label">E-mail</label>
                        <input 
                            type="email" 
                            id="edit-email" 
                            name="email"
                            class="form-input"
                            required
                        >
                    </div>

                    <!-- Telefone -->
                    <div>
                        <label for="edit-telefone" class="form-label">Telefone</label>
                        <input 
                            type="tel" 
                            id="edit-telefone" 
                            name="telefone"
                            placeholder="(84) 99999-9999"
                            class="form-input"
                            maxlength="15"
                        >
                    </div>

                    <!-- Data de Nascimento -->
                    <div>
                        <label for="edit-data_nascimento" class="form-label">Data de Nascimento</label>
                        <input 
                            type="date" 
                            id="edit-data_nascimento" 
                            name="data_nascimento"
                            class="form-input"
                            required
                        >
                    </div>

                    <!-- Escolaridade -->
                    <div>
                        <label for="edit-escolaridade" class="form-label">Escolaridade</label>
                        <select 
                            id="edit-escolaridade" 
                            name="escolaridade"
                            class="form-input"
                            required
                        >
                            <option value="">Selecione...</option>
                            <option value="Ensino Fundamental">Ensino Fundamental</option>
                            <option value="Ensino Médio">Ensino Médio</option>
                            <option value="Superior Incompleto">Superior Incompleto</option>
                            <option value="Superior Completo">Superior Completo</option>
                            <option value="Pós-graduação">Pós-graduação</option>
                        </select>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeEditModal()" class="btn-secondary">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        <i data-lucide="save" class="w-4 h-4"></i>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Account Info Section -->
<div class="bg-white rounded-xl p-6 border border-gray-200">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Informações da Conta</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
        <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="text-gray-500 sm:mr-2">ID do Usuário:</span>
            <span id="user-id" class="font-medium text-gray-900">-</span>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="text-gray-500 sm:mr-2">Membro desde:</span>
            <span id="created-at" class="font-medium text-gray-900">-</span>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="text-gray-500 sm:mr-2">Termos aceitos:</span>
            <span id="terms-accepted" class="font-medium text-gray-900">-</span>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-center">
            <span class="text-gray-500 sm:mr-2">Status:</span>
            <span id="account-status" class="font-medium text-gray-900">-</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let originalData = {};

    async function loadProfile() {
        try {
            const token = localStorage.getItem('token');
            
            if (!token) {
                alert('Token não encontrado. Faça login novamente.');
                window.location.href = '/login';
                return;
            }
            
            const response = await fetch('/api/me', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                populateForm(data);
                originalData = { ...data };
            } else {
                const errorText = await response.text();
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('apelido');
                    alert('Sessão expirada. Faça login novamente.');
                    window.location.href = '/login';
                } else {
                    alert('Erro ao carregar perfil: ' + errorText);
                }
            }
        } catch (error) {
            alert('Erro ao carregar perfil');
        }
    }

    function populateForm(data) {
        // Display fields (read-only)
        document.getElementById('display-nome_completo').textContent = data.nome_completo || '-';
        document.getElementById('display-apelido').textContent = data.apelido || '-';
        document.getElementById('display-email').textContent = data.email || '-';
        document.getElementById('display-telefone').textContent = data.telefone || '-';
        document.getElementById('display-data_nascimento').textContent = data.data_nascimento ? new Date(data.data_nascimento).toLocaleDateString('pt-BR') : '-';
        document.getElementById('display-escolaridade').textContent = data.escolaridade || '-';
        
        // Edit modal fields
        document.getElementById('edit-nome_completo').value = data.nome_completo || '';
        document.getElementById('edit-apelido').value = data.apelido || '';
        document.getElementById('edit-email').value = data.email || '';
        document.getElementById('edit-telefone').value = data.telefone || '';
        document.getElementById('edit-data_nascimento').value = data.data_nascimento ? data.data_nascimento.split('T')[0] : '';
        document.getElementById('edit-escolaridade').value = data.escolaridade || '';
        
        document.getElementById('profile-name').textContent = data.nome_completo || 'Usuário';
        document.getElementById('profile-email').textContent = data.email || '';
        document.getElementById('profile-role').textContent = data.is_admin ? 'Administrador' : 'Usuário';
        
        document.getElementById('user-id').textContent = data.id || '-';
        document.getElementById('created-at').textContent = data.created_at ? new Date(data.created_at).toLocaleDateString('pt-BR') : '-';
        document.getElementById('terms-accepted').textContent = data.aceitou_termos ? 'Sim' : 'Não';
        document.getElementById('account-status').textContent = 'Ativo';
    }

    function openEditModal() {
        const modal = document.getElementById('edit-modal');
        modal.classList.remove('hidden');
        lucide.createIcons();
    }

    function closeEditModal() {
        const modal = document.getElementById('edit-modal');
        modal.classList.add('hidden');
        // Reset form to original data
        populateForm(originalData);
    }

    document.getElementById('edit-telefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
        }
        if (value.length >= 10) {
            value = value.substring(0, 10) + '-' + value.substring(10, 14);
        }
        e.target.value = value;
    });


    document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                data[key] = value;
            }
        }
        
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Token não encontrado. Faça login novamente.');
                window.location.href = '/login';
                return;
            }
            
            const response = await fetch('/api/perfil', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Perfil atualizado com sucesso!');
                closeEditModal();
                loadProfile();
            } else {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('apelido');
                    alert('Sessão expirada. Faça login novamente.');
                    window.location.href = '/login';
                } else {
                    const error = await response.json();
                    alert('Erro: ' + error.error);
                }
            }
        } catch (error) {
            alert('Erro ao atualizar perfil');
        }
    });

    document.getElementById('edit-toggle').addEventListener('click', openEditModal);

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Você precisa estar logado para acessar esta página.');
            window.location.href = '/login';
            return;
        }
        loadProfile();
    });
</script>
{% endblock %}
