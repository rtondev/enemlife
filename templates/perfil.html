{% extends "dashboard_base.html" %}

{% block title %}Meu Perfil - ENEMPRO{% endblock %}

{% block content %}
<div class="p-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Meu Perfil</h1>
        <p class="text-gray-600">Gerencie suas informações pessoais e configurações da conta</p>
    </div>

    <!-- Profile Card -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8">
        <!-- Profile Header -->
        <div class="flex items-center space-x-6 mb-8">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center">
                <i data-lucide="user" class="w-10 h-10 text-blue-600"></i>
            </div>
            <div>
                <h2 id="profile-name" class="text-xl font-semibold text-gray-900">Carregando...</h2>
                <p id="profile-email" class="text-gray-600">Carregando...</p>
                <span id="profile-role" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mt-2">
                    Carregando...
                </span>
            </div>
        </div>

        <!-- Edit Mode Toggle -->
        <div class="flex justify-end mb-6">
            <button id="edit-toggle" class="btn-primary">
                <i data-lucide="edit-3" class="w-4 h-4"></i>
                Editar Perfil
            </button>
        </div>

        <!-- Profile Form -->
        <form id="profile-form" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Nome Completo -->
                <div>
                    <label for="nome_completo" class="form-label">
                        Nome Completo
                    </label>
                    <input 
                        type="text" 
                        id="nome_completo" 
                        name="nome_completo"
                        class="form-input"
                        readonly
                        required
                    >
                </div>

                <!-- Apelido -->
                <div>
                    <label for="apelido" class="form-label">
                        Apelido
                    </label>
                    <input 
                        type="text" 
                        id="apelido" 
                        name="apelido"
                        class="form-input"
                        readonly
                        required
                    >
                </div>

                <!-- Email -->
                <div>
                    <label for="email" class="form-label">
                        E-mail
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email"
                        class="form-input"
                        readonly
                        required
                    >
                </div>

                <!-- Telefone -->
                <div>
                    <label for="telefone" class="form-label">
                        Telefone
                    </label>
                    <input 
                        type="tel" 
                        id="telefone" 
                        name="telefone"
                        placeholder="(84) 99999-9999"
                        class="form-input"
                        readonly
                        maxlength="15"
                    >
                </div>

                <!-- Data de Nascimento -->
                <div>
                    <label for="data_nascimento" class="form-label">
                        Data de Nascimento
                    </label>
                    <input 
                        type="date" 
                        id="data_nascimento" 
                        name="data_nascimento"
                        class="form-input"
                        readonly
                        required
                    >
                </div>

                <!-- Escolaridade -->
                <div>
                    <label for="escolaridade" class="form-label">
                        Escolaridade
                    </label>
                    <select 
                        id="escolaridade" 
                        name="escolaridade"
                        class="form-input"
                        readonly
                        required
                    >
                        <option value="">Selecione...</option>
                        <option value="Ensino Fundamental">Ensino Fundamental</option>
                        <option value="Ensino Médio">Ensino Médio</option>
                        <option value="Superior Incompleto">Superior Incompleto</option>
                        <option value="Superior Completo">Superior Completo</option>
                        <option value="Pós-graduação">Pós-graduação</option>
                    </select>
                </div>
            </div>

            <!-- Nova Senha (só aparece no modo de edição) -->
            <div id="password-section" class="hidden">
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Alterar Senha</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="nova_senha" class="form-label">
                                Nova Senha
                            </label>
                            <input 
                                type="password" 
                                id="nova_senha" 
                                name="nova_senha"
                                placeholder="Deixe em branco para não alterar"
                                class="form-input"
                                minlength="8"
                            >
                        </div>
                        <div>
                            <label for="confirmar_senha" class="form-label">
                                Confirmar Nova Senha
                            </label>
                            <input 
                                type="password" 
                                id="confirmar_senha" 
                                name="confirmar_senha"
                                placeholder="Confirme a nova senha"
                                class="form-input"
                                minlength="8"
                            >
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="action-buttons" class="flex justify-end space-x-3 hidden">
                <button type="button" id="cancel-edit" class="btn-secondary">
                    <i data-lucide="x" class="w-4 h-4"></i>
                    Cancelar
                </button>
                <button type="submit" class="btn-primary">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Salvar Alterações
                </button>
            </div>
        </form>

        <!-- Account Info -->
        <div class="border-t border-gray-200 pt-6 mt-8">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Informações da Conta</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <span class="text-gray-500">ID do Usuário:</span>
                    <span id="user-id" class="ml-2 font-medium">-</span>
                </div>
                <div>
                    <span class="text-gray-500">Membro desde:</span>
                    <span id="created-at" class="ml-2 font-medium">-</span>
                </div>
                <div>
                    <span class="text-gray-500">Termos aceitos:</span>
                    <span id="terms-accepted" class="ml-2 font-medium">-</span>
                </div>
                <div>
                    <span class="text-gray-500">Status:</span>
                    <span id="account-status" class="ml-2 font-medium">-</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let isEditing = false;
    let originalData = {};

    async function loadProfile() {
        try {
            const token = localStorage.getItem('token');
            
            if (!token) {
                alert('Token não encontrado. Faça login novamente.');
                window.location.href = '/login';
                return;
            }
            
            const response = await fetch('/api/me', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                populateForm(data);
                originalData = { ...data };
            } else {
                const errorText = await response.text();
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('apelido');
                    alert('Sessão expirada. Faça login novamente.');
                    window.location.href = '/login';
                } else {
                    alert('Erro ao carregar perfil: ' + errorText);
                }
            }
        } catch (error) {
            alert('Erro ao carregar perfil');
        }
    }

    function populateForm(data) {
        document.getElementById('nome_completo').value = data.nome_completo || '';
        document.getElementById('apelido').value = data.apelido || '';
        document.getElementById('email').value = data.email || '';
        document.getElementById('telefone').value = data.telefone || '';
        document.getElementById('data_nascimento').value = data.data_nascimento ? data.data_nascimento.split('T')[0] : '';
        document.getElementById('escolaridade').value = data.escolaridade || '';
        
        document.getElementById('profile-name').textContent = data.nome_completo || 'Usuário';
        document.getElementById('profile-email').textContent = data.email || '';
        document.getElementById('profile-role').textContent = data.is_admin ? 'Administrador' : 'Usuário';
        
        document.getElementById('user-id').textContent = data.id || '-';
        document.getElementById('created-at').textContent = data.created_at ? new Date(data.created_at).toLocaleDateString('pt-BR') : '-';
        document.getElementById('terms-accepted').textContent = data.aceitou_termos ? 'Sim' : 'Não';
        document.getElementById('account-status').textContent = 'Ativo';
    }

    function toggleEditMode() {
        isEditing = !isEditing;
        const inputs = document.querySelectorAll('#profile-form input, #profile-form select');
        const actionButtons = document.getElementById('action-buttons');
        const passwordSection = document.getElementById('password-section');
        const editToggle = document.getElementById('edit-toggle');
        
        inputs.forEach(input => {
            input.readOnly = !isEditing;
            if (isEditing) {
                input.classList.remove('bg-gray-50');
                input.classList.add('bg-white');
            } else {
                input.classList.add('bg-gray-50');
                input.classList.remove('bg-white');
            }
        });
        
        if (isEditing) {
            actionButtons.classList.remove('hidden');
            passwordSection.classList.remove('hidden');
            editToggle.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i> Cancelar Edição';
        } else {
            actionButtons.classList.add('hidden');
            passwordSection.classList.add('hidden');
            editToggle.innerHTML = '<i data-lucide="edit-3" class="w-4 h-4"></i> Editar Perfil';
            populateForm(originalData);
        }
    }

    document.getElementById('telefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
        }
        if (value.length >= 10) {
            value = value.substring(0, 10) + '-' + value.substring(10, 14);
        }
        e.target.value = value;
    });

    document.getElementById('confirmar_senha').addEventListener('input', function() {
        const novaSenha = document.getElementById('nova_senha').value;
        const confirmarSenha = this.value;
        
        if (confirmarSenha && novaSenha !== confirmarSenha) {
            this.setCustomValidity('As senhas não coincidem');
        } else {
            this.setCustomValidity('');
        }
    });

    document.getElementById('profile-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!isEditing) return;
        
        const formData = new FormData(this);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
            if (value.trim()) {
                data[key] = value;
            }
        }
        
        if (data.nova_senha && data.nova_senha !== data.confirmar_senha) {
            alert('As senhas não coincidem!');
            return;
        }
        
        delete data.confirmar_senha;
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('Token não encontrado. Faça login novamente.');
                window.location.href = '/login';
                return;
            }
            
            const response = await fetch('/api/perfil', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Perfil atualizado com sucesso!');
                toggleEditMode();
                loadProfile();
            } else {
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user_id');
                    localStorage.removeItem('apelido');
                    alert('Sessão expirada. Faça login novamente.');
                    window.location.href = '/login';
                } else {
                    const error = await response.json();
                    alert('Erro: ' + error.error);
                }
            }
        } catch (error) {
            alert('Erro ao atualizar perfil');
        }
    });

    document.getElementById('edit-toggle').addEventListener('click', toggleEditMode);
    document.getElementById('cancel-edit').addEventListener('click', toggleEditMode);

    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Você precisa estar logado para acessar esta página.');
            window.location.href = '/login';
            return;
        }
        loadProfile();
    });
</script>
{% endblock %}
